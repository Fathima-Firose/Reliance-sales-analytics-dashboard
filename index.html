<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reliance Trends Madurai Sales Analytics Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* --- 1. THEME & DESIGN --- */
        :root {
            --primary-color: #6A0DAD; /* Deep Purple */
            --secondary-color: #A06AD7; /* Lighter Purple */
            --tertiary-color: #4C0877; /* Darker Purple */
            --accent-color: #BA55D3; /* Medium Orchid */
            --white-color: #ffffff;
            --dark-text: #333;
            --light-text: #f4f4f4;
            --bg-color: #f8f8fc; /* Very light subtle background */
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1); /* Lighter shadow */
            --shadow-deep: 0 8px 20px rgba(0, 0, 0, 0.2);
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--dark-text);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

          /* --- HEADER --- */
        header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-deep);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            height: 70px;
        }

        header .logo-container {
            display: flex;
            align-items: center;
        }

        header .trends-logo-img {
            height: 40px; /* Standardize image height */
            margin-right: 15px;
            object-fit: contain;
            /* Added border for visual pop, consistent with theme */
            border-right: 2px solid rgba(255, 255, 255, 0.5);
            padding-right: 15px;
        }

        header .logo {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        header .location {
            font-size: 16px;
            opacity: 0.8;
            font-weight: 300;
        }
        
        /* --- SIDE NAVIGATION (SIDEBAR) --- */
        #sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: var(--white-color);
            position: fixed;
            top: 70px;
            height: calc(100% - 70px);
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            transition: width var(--transition-speed), transform var(--transition-speed);
            overflow-y: auto;
            z-index: 900;
        }

        #sidebar.collapsed {
            width: 60px;
        }

        #sidebar nav a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--white-color);
            text-decoration: none;
            transition: background-color var(--transition-speed), padding-left var(--transition-speed);
            white-space: nowrap;
            overflow: hidden;
            font-weight: 500;
        }

        #sidebar nav a:hover {
            background-color: var(--secondary-color);
            padding-left: 25px;
        }

        #sidebar nav a.active {
            background-color: var(--tertiary-color);
            border-left: 5px solid var(--accent-color); /* Use accent for pop */
            padding-left: 25px;
        }

        #sidebar .material-symbols-outlined {
            margin-right: 15px;
            font-size: 24px;
        }

        #sidebar.collapsed nav a .nav-text {
            display: none;
        }

        /* --- MAIN CONTENT & Filters --- */
        #main-content {
            margin-left: 250px;
            padding: 90px 20px 20px 20px;
            width: 100%;
            transition: margin-left var(--transition-speed);
        }

        #main-content.shifted {
            margin-left: 60px;
        }
        
        .filter-section {
            background-color: var(--white-color);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .filter-section select {
            padding: 8px 12px;
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-section select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(176, 137, 203, 0.5);
        }

        /* --- LAYOUT & SECTIONS --- */
        .dashboard-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
            min-height: 100vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--tertiary-color);
            margin-bottom: 25px;
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 10px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }

        h2 .material-symbols-outlined {
            margin-right: 10px;
        }

        h3 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f5;
        }

        /* --- Grid System & Alignment Fixes --- */
        .kpi-cards, .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            grid-auto-rows: minmax(120px, auto); /* Consistent row height for KPIs */
        }

        .chart-grid {
             grid-auto-rows: 400px; /* Standardize chart height */
        }
        
        .chart-grid-full-span {
            grid-column: 1 / -1; /* For elements that span the whole width */
            grid-auto-rows: minmax(400px, auto);
        }

        /* --- CARDS & EFFECTS --- */
        .card {
            background-color: var(--white-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100%; /* Important for grid alignment */
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(106, 13, 173, 0.3); /* Subtle purple glow on hover */
        }

        .kpi-card {
            text-align: center;
            cursor: default;
            justify-content: center;
        }

        .kpi-card .value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-color);
            margin: 5px 0;
            line-height: 1.2;
        }

        .kpi-card .label {
            font-size: 0.9rem;
            color: var(--dark-text);
            opacity: 0.8;
            font-weight: 500;
        }

        .chart-plot {
            flex-grow: 1;
            /* Plotly containers need defined size */
            height: calc(100% - 75px); 
            min-height: 300px;
        }

        #map-container {
            height: 100%; /* Fill the container */
            border-radius: 8px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1);
        }

        /* Table Visualization Style */
        .table-visualization {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .table-visualization th, .table-visualization td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .table-visualization th {
            background-color: var(--secondary-color);
            color: var(--white-color);
            font-weight: 600;
        }

        .table-visualization tbody tr:nth-child(even) {
            background-color: #f7f7ff;
        }

        .insight-text {
            padding: 15px;
            background-color: #e6e6fa; /* Light lavender for insights */
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--dark-text);
        }

        /* --- RESPONSIVENESS --- */
        @media (max-width: 992px) {
            #sidebar { width: 60px; }
            #sidebar nav a .nav-text { display: none; }
            #sidebar nav a { justify-content: center; }
            #main-content { margin-left: 60px; }
            .kpi-cards, .chart-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .trends-logo-img { height: 30px; width: 30px; }
            header .logo { font-size: 20px; }
        }

        @media (max-width: 768px) {
            header { padding: 10px 20px; height: 60px; }
            #sidebar { top: 60px; height: calc(100% - 60px); transform: translateX(-100%); width: 250px; }
            #sidebar.open { transform: translateX(0); }
            #main-content { margin-left: 0; padding-top: 80px; }
            .toggle-btn { display: block !important; }
            .filter-section { flex-direction: column; align-items: flex-start; }
            .chart-grid { grid-auto-rows: 350px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="trends.png" alt="TRENDS Logo" class="trends-logo-img">

            <div class="logo">Reliance Trends Madurai Sales Analytics Dashboard</div>
        </div>
        <div>
            <div class="location">Madurai Analytics Hub</div>
        </div>
        <button class="toggle-btn" id="sidebar-toggle-mobile" style="display: none;">
            <span class="material-symbols-outlined">menu</span>
        </button>
    </header>

    <div id="sidebar">
        <button class="toggle-btn" id="sidebar-toggle-desktop">
            <span class="material-symbols-outlined">chevron_left</span>
        </button>
        <nav>
            <a href="#home" class="nav-item active" data-section="home">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="nav-text">Dashboard Home</span>
            </a>
            <a href="#sales" class="nav-item" data-section="sales">
                <span class="material-symbols-outlined">trending_up</span>
                <span class="nav-text">Sales Analytics</span>
            </a>
            <a href="#pricing" class="nav-item" data-section="pricing">
                <span class="material-symbols-outlined">sell</span>
                <span class="nav-text">Pricing Insights</span>
            </a>
            <a href="#profitability" class="nav-item" data-section="profitability">
                <span class="material-symbols-outlined">attach_money</span>
                <span class="nav-text">Profitability Metrics</span>
            </a>
            <a href="#distribution" class="nav-item" data-section="distribution">
                <span class="material-symbols-outlined">map</span>
                <span class="nav-text">Location Map</span>
            </a>
        </nav>
    </div>

    <main id="main-content">

        <div class="filter-section">
            <label for="year-filter">Filter by Year:</label>
            <select id="year-filter" onchange="updateDashboard()">
                <option value="All">All Years</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
            </select>
            <label for="location-filter">Filter by Location:</label>
            <select id="location-filter" onchange="updateDashboard()">
                <option value="All">All Locations</option>
                </select>
        </div>

        <section id="home" class="dashboard-section active">
            <h2><span class="material-symbols-outlined">home</span>Dashboard Home: Comprehensive Sales Insights</h2>

            <div class="kpi-cards">
                <div class="card kpi-card">
                    <div class="label">Total Revenue (All Time)</div>
                    <div class="value" id="kpi-revenue">₹0.00 Cr</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Total Transactions</div>
                    <div class="value" id="kpi-transactions">0</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Average Purchase Value</div>
                    <div class="value" id="kpi-apv">₹0.00</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Gross Profit Margin (Est.)</div>
                    <div class="value" id="kpi-gpm">0.0%</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="card">
                    <h3>1. Annual Revenue Trend</h3>
                    <div id="revenue-trend-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>2. Sales Revenue by Age Group</h3>
                    <div id="age-sales-chart" class="chart-plot"></div>
                </div>
            </div>

            <div class="chart-grid">
                 <div class="card">
                    <h3>3. Location-wise Sales Contribution</h3>
                    <div id="location-sales-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>4. Top 5 Product Sales (Revenue)</h3>
                    <div id="product-sales-chart" class="chart-plot"></div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="card">
                    <h3>5. Revenue Split: Discount vs. No Discount</h3>
                    <div id="promotion-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>6. Revenue by Distribution Channel</h3>
                    <div id="distribution-chart" class="chart-plot"></div>
                </div>
            </div>
            
        </section>

        <section id="sales" class="dashboard-section">
            <h2><span class="material-symbols-outlined">trending_up</span>Sales Analytics: Deep Dive</h2>
            
             <div class="kpi-cards">
                <div class="card kpi-card">
                    <div class="label">Total Customers</div>
                    <div class="value" id="kpi-customers">0+</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Repeat Purchase Rate</div>
                    <div class="value" id="kpi-repeat">0.0%</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Customer Conversion Rate</div>
                    <div class="value" id="kpi-conversion-sales">0.0%</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Average Review Rating</div>
                    <div class="value" id="kpi-rating">0.0 / 5.0</div>
                </div>
            </div>

            <div class="chart-grid chart-grid-full-span">
                <div class="card" style="grid-column: span 2;">
                    <h3>1. Sales Conversion Funnel (Visits to Purchase)</h3>
                    <div id="sales-funnel-chart" class="chart-plot"></div>
                </div>
            </div>
            
            <div class="chart-grid">
                 <div class="card">
                    <h3>2. Monthly Trend: Online vs. Offline Sales</h3>
                    <div id="online-offline-trend-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>3. Category-wise Sales Volume (Units)</h3>
                    <div id="category-sales-chart" class="chart-plot"></div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="card">
                    <h3>4. Customer Segmentation by Purchase Frequency</h3>
                    <div id="customer-segmentation-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>5. Competitor vs. Our Sales (Est. Market Share)</h3>
                    <div id="competitor-comparison-chart" class="chart-plot"></div>
                </div>
            </div>
        </section>

        <section id="pricing" class="dashboard-section">
            <h2><span class="material-symbols-outlined">sell</span>Pricing Insights: Strategy and Elasticity</h2>

            <div class="chart-grid">
                <div class="card">
                    <h3>1. Price Elasticity Curve (Avg. Price vs. Demand Volume)</h3>
                    <div id="demand-elasticity-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>2. Average Selling Price Trend (Monthly)</h3>
                    <div id="avg-price-trend-chart" class="chart-plot"></div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="card">
                    <h3>3. Product Category Price Distribution (Box Plot)</h3>
                    <div id="price-distribution-box-plot" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>4. Customer Willingness-to-Pay (WTP) by Segment</h3>
                    <div id="wtp-bubble-chart" class="chart-plot"></div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="card">
                    <h3>5. Competitor-wise Pricing Comparison (Avg. Price)</h3>
                    <div id="competitor-pricing-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>6. B2B Bulk Discount Tiers & Target Margin</h3>
                    <table class="table-visualization">
                        <thead>
                            <tr><th>Volume Tier</th><th>Discount %</th><th>Target Margin %</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1-10 Units (Retail)</td><td>0%</td><td>30%</td></tr>
                            <tr><td>11-50 Units (Small B2B)</td><td>5%</td><td>25%</td></tr>
                            <tr><td>51-200 Units (Mid B2B)</td><td>10%</td><td>22%</td></tr>
                            <tr><td>200+ Units (Bulk Partner)</td><td>15%</td><td>20%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="profitability" class="dashboard-section">
            <h2><span class="material-symbols-outlined">attach_money</span>Profitability Metrics: Margin and ROI</h2>
            
            <div class="kpi-cards">
                <div class="card kpi-card">
                    <div class="label">Total Estimated Profit</div>
                    <div class="value" id="kpi-profit">₹0.00 Cr</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Cost of Goods Sold (COGS)</div>
                    <div class="value" id="kpi-cogs">₹0.00 Cr</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Customer Acquisition Cost (CAC)</div>
                    <div class="value" id="kpi-cac">₹900.00</div>
                </div>
                <div class="card kpi-card">
                    <div class="label">Customer Lifetime Value (LTV)</div>
                    <div class="value" id="kpi-ltv">₹4,500.00</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="card">
                    <h3>1. Profit Margin Trend Over Time (Quarterly)</h3>
                    <div id="margin-trend-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>2. Product-wise Profit Contribution (Top 5)</h3>
                    <div id="product-profit-chart" class="chart-plot"></div>
                </div>
            </div>
            
            <div class="chart-grid">
                 <div class="card">
                    <h3>3. Region-wise Profitability (Revenue Split)</h3>
                    <div id="region-profit-pie-chart" class="chart-plot"></div>
                </div>
                <div class="card">
                    <h3>4. Promotion ROI vs. Spend</h3>
                    <div id="promotion-roi-scatter" class="chart-plot"></div>
                </div>
            </div>
            
            <div class="chart-grid chart-grid-full-span">
                <div class="card" style="min-height: auto; grid-column: span 2;">
                    <h3>5. Gross Margin by Category (Est. COGS: 70%)</h3>
                    <table class="table-visualization">
                        <thead>
                            <tr><th>Category</th><th>Total Revenue (₹)</th><th>Est. Gross Profit (₹)</th><th>Est. Margin %</th></tr>
                        </thead>
                        <tbody id="profitability-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="distribution" class="dashboard-section">
            <h2><span class="material-symbols-outlined">map</span>Retail Location Scoring Map: Madurai</h2>
            <div class="chart-grid">
                <div class="card" style="grid-column: span 2; height: 600px; padding: 10px;">
                    <h3>Branch Revenue and Location Proximity Visualization</h3>
                    <div id="map-container"></div>
                </div>
            </div>
            <div class="insight-text">
                **Insight:** The map visualizes **Branch Revenue** (size of circle) and **Location Score** (color intensity). The analysis can be used for strategic expansion and inventory distribution planning.
            </div>
        </section>

    </main>

    <script>
        // --- SYNTHESIZED SAMPLE DATA (Adjusted for Indian Context) ---
        const MADURAI_LOCATIONS = {
            "Anna Nagar": { lat: 9.933, lon: 78.140, score: 95, competitor: 3, sales: 0 },
            "KK Nagar": { lat: 9.9343, lon: 78.1460, score: 88, competitor: 5, sales: 0 },
            "Ponmeni": { lat: 9.9257, lon: 78.0909, score: 72, competitor: 1, sales: 0 },
            "CS Nagar": { lat: 9.920, lon: 78.130, score: 98, competitor: 7, sales: 0 },
            "BB Kulam": { lat: 9.928, lon: 78.135, score: 85, competitor: 4, sales: 0 },
            "Thirumangalam": { lat: 9.870, lon: 77.985, score: 65, competitor: 2, sales: 0 },
            "Meenakshi Nagar": { lat: 9.922, lon: 78.105, score: 78, competitor: 3, sales: 0 },
            "Chinna Chokikulam": { lat: 9.920, lon: 78.125, score: 90, competitor: 6, sales: 0 },
            "Palangantham": { lat: 9.910, lon: 78.115, score: 80, competitor: 5, sales: 0 },
            "Iyer Bungalow": { lat: 9.940, lon: 78.150, score: 70, competitor: 2, sales: 0 },
        };

        const ITEM_LIST = ['Jeans', 'Backpack', 'T-shirt', 'Sneakers', 'Jacket', 'Shoes', 'Dress', 'Shorts', 'Shirt', 'Watch'];
        const CATEGORIES = ['Clothing', 'Footwear', 'Accessories', 'Outerwear'];

        // --- ENHANCED PURPLE PALETTE (Varied Shades) ---
        const PURPLE_PALETTE = [
            '#6A0DAD', // Deep Purple (Primary)
            '#8A2BE2', // Blue-Violet
            '#9966CC', // Lavender Purple
            '#BA55D3', // Medium Orchid (Accent)
            '#9370DB', // Medium Purple
            '#C3B1E1', // Pale Lavender
            '#4C0877', // Darker Purple (Tertiary)
            '#7B68EE', // Medium Slate Blue
            '#E6E6FA', // Lightest Lavender
            '#DDA0DD'  // Plum
        ];
        
        // --- COMPETITOR DATA ---
        const COMPETITORS = ['Pantaloons', 'Max Fashion', 'Lifestyle', 'Reliance Trends'];

        // Function to generate high-quality synthetic data
        function generateSyntheticData(targetCount) {
            const data = [];
            const locations = Object.keys(MADURAI_LOCATIONS);

            for (let i = 0; i < targetCount; i++) {
                const year = 2020 + Math.floor(Math.random() * 5); // 2020 to 2024
                const month = Math.floor(Math.random() * 12) + 1;
                const category = CATEGORIES[Math.floor(Math.random() * CATEGORIES.length)];
                const location = locations[Math.floor(Math.random() * locations.length)];
                const age = Math.floor(Math.random() * (70 - 18 + 1)) + 18;

                let basePrice = 2500;
                if (category === 'Clothing') basePrice = 3000;
                if (category === 'Footwear') basePrice = 4500;
                if (category === 'Outerwear') basePrice = 6000;
                
                const price = Math.round(basePrice * (0.8 + Math.random() * 0.4));
                const isOnline = Math.random() < 0.35; // 35% online sales
                const shipping = isOnline ? ['Standard', 'Express'][Math.floor(Math.random() * 2)] : 'Store Pickup';

                data.push({
                    id: i + 1,
                    year: year,
                    month: month,
                    category: category,
                    location: location,
                    age: age,
                    item_purchased: ITEM_LIST[Math.floor(Math.random() * ITEM_LIST.length)],
                    price: price, // Transaction value
                    shipping_type: shipping,
                    discount_applied: Math.random() < 0.40 ? 'Yes' : 'No',
                    previous_purchases: Math.floor(Math.random() * 50) + 1,
                    is_online: isOnline,
                    competitor: COMPETITORS[Math.floor(Math.random() * COMPETITORS.length)], // Used for comparison
                    promotion_spend: Math.random() * 1000 + 100, // For ROI chart
                    promotion_roi: Math.random() * 5 + 1.5, // For ROI chart
                });
            }
            return data;
        }

        const SALES_DATA = generateSyntheticData(12000); // Increased transactions

        // Function to assign age to a group
        function getAgeGroup(age) {
            if (age < 25) return '18-24';
            if (age < 35) return '25-34';
            if (age < 50) return '35-49';
            if (age < 65) return '50-64';
            return '65+';
        }

        // Initialize Location Filter Options
        function populateLocationFilter() {
            const select = document.getElementById('location-filter');
            Object.keys(MADURAI_LOCATIONS).forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                select.appendChild(option);
            });
        }

        // --- HELPER FUNCTION FOR CURRENCY FORMATTING ---
        function formatCurrency(value) {
            return `₹${value.toLocaleString('en-IN', { maximumFractionDigits: 0 })}`;
        }

        function formatCurrencySmall(value) {
            return `₹${value.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        function formatCr(value) {
            const cr = value / 10000000;
            return `₹${cr.toFixed(2)} Cr`;
        }
        
        function formatPercent(value) {
            return `${(value).toFixed(1)}%`;
        }

        // --- CORE DATA PROCESSING FUNCTION ---
        function filterData(data, year, location) {
            let filtered = data;
            if (year !== 'All') {
                filtered = filtered.filter(d => d.year.toString() === year);
            }
            if (location !== 'All') {
                filtered = filtered.filter(d => d.location === location);
            }
            return filtered;
        }

        function calculateMetrics(filteredData) {
            const allTimeRevenue = SALES_DATA.reduce((sum, d) => sum + d.price, 0);
            const totalTransactions = SALES_DATA.length;
            const avgRating = 4.2; // Fixed value for aesthetic
            const totalCustomers = 4500; // Fixed value for aesthetic
            const repeatRate = 42.5; // Fixed value for aesthetic
            const conversion = 3.2; // Fixed value for aesthetic
            const grossMarginPercent = 0.30;
            const estimatedProfit = allTimeRevenue * grossMarginPercent;
            const estimatedCOGS = allTimeRevenue * (1 - grossMarginPercent);
            const apv = allTimeRevenue / totalTransactions;

            // Simplified CAC/LTV based on the total transactions
            const kpi_ltv = apv * (1 + repeatRate / 100) * 3; 
            const kpi_cac = kpi_ltv * 0.2; 

            return {
                totalTransactions,
                allTimeRevenue,
                apv,
                avgRating,
                totalCustomers,
                estimatedProfit,
                estimatedCOGS,
                grossMarginPercent,
                repeatRate: formatPercent(repeatRate),
                conversion: formatPercent(conversion),
                kpi_ltv: kpi_ltv,
                kpi_cac: kpi_cac
            };
        }

        // --- PLOTLY CHART FUNCTIONS ---

        // Home Section Charts

        // 1. Annual Revenue Trend
        function createRevenueTrendChart(data) {
            const revenueByYear = data.reduce((acc, d) => { acc[d.year] = (acc[d.year] || 0) + d.price; return acc; }, {});
            const years = Object.keys(revenueByYear).sort();
            const revValues = years.map(y => revenueByYear[y]);

            Plotly.newPlot('revenue-trend-chart', [{
                x: years, y: revValues, type: 'bar',
                marker: { color: PURPLE_PALETTE[0] },
                hovertemplate: 'Year: %{x}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{y:,.0f}<extra></extra>'
            }], {
                title: 'Annual Revenue Trend', margin: { t: 40, b: 60 }, yaxis: { title: 'Revenue (₹)' }
            }, { responsive: true, displayModeBar: false });
        }

        // 2. Age-wise Sales Chart
        function createAgeSalesChart(data) {
            const salesByAgeGroup = data.reduce((acc, d) => {
                const group = getAgeGroup(d.age);
                acc[group] = (acc[group] || 0) + d.price;
                return acc;
            }, {});

            const groups = Object.keys(salesByAgeGroup).sort();
            const revenue = groups.map(g => salesByAgeGroup[g]);

            Plotly.newPlot('age-sales-chart', [{
                x: groups, y: revenue, type: 'bar',
                marker: { color: PURPLE_PALETTE[1] },
                hovertemplate: 'Age Group: %{x}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{y:,.0f}<extra></extra>'
            }], {
                title: 'Revenue by Age Group', margin: { t: 40, b: 60 }, yaxis: { title: 'Revenue (₹)' }
            }, { responsive: true, displayModeBar: false });
        }

        // 3. Location-wise Sales Chart
        function createLocationSalesChart(data) {
            const salesByLocation = data.reduce((acc, d) => { acc[d.location] = (acc[d.location] || 0) + d.price; return acc; }, {});
            const locations = Object.keys(salesByLocation);
            const revenue = Object.values(salesByLocation);

            Plotly.newPlot('location-sales-chart', [{
                x: locations, y: revenue, type: 'bar',
                marker: { color: PURPLE_PALETTE[3] },
                hovertemplate: 'Location: %{x}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{y:,.0f}<extra></extra>'
            }], {
                title: 'Revenue by Branch Location', margin: { t: 40, b: 100, l: 60, r: 20 }, yaxis: { title: 'Revenue (₹)' }, xaxis: { tickangle: -45 }
            }, { responsive: true, displayModeBar: false });
        }
        
        // 4. Product-wise Sales Chart (Top 5)
        function createProductSalesChart(data) {
            const salesByItem = data.reduce((acc, d) => { acc[d.item_purchased] = (acc[d.item_purchased] || 0) + d.price; return acc; }, {});
            const sortedItems = Object.entries(salesByItem).sort(([, a], [, b]) => b - a).slice(0, 5);
            const items = sortedItems.map(([item]) => item).reverse();
            const revenue = sortedItems.map(([, rev]) => rev).reverse();

            Plotly.newPlot('product-sales-chart', [{
                x: revenue, y: items, type: 'bar', orientation: 'h',
                marker: { color: PURPLE_PALETTE[2] },
                hovertemplate: 'Product: %{y}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{x:,.0f}<extra></extra>'
            }], {
                title: 'Top 5 Products by Revenue', margin: { t: 40, b: 40, l: 100, r: 20 }, xaxis: { title: 'Revenue (₹)' }
            }, { responsive: true, displayModeBar: false });
        }

        // 5. Promotion Chart (Pie/Doughnut)
        function createPromotionChart(data) {
            const promoCounts = data.reduce((acc, d) => {
                const key = d.discount_applied === 'Yes' ? 'Discount Applied' : 'No Discount';
                acc[key] = (acc[key] || 0) + d.price;
                return acc;
            }, {});

            const labels = Object.keys(promoCounts);
            const values = Object.values(promoCounts);

            const trace = {
                labels: labels, values: values, type: 'pie',
                marker: { colors: [PURPLE_PALETTE[4], PURPLE_PALETTE[6]] },
                hovertemplate: '%{label}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{value:,.0f} (%{percent})<extra></extra>',
                hole: .6
            };
            const layout = { title: 'Revenue Split: Discount vs. No Discount', margin: { t: 40, b: 20, l: 20, r: 20 }, showlegend: true };
            Plotly.newPlot('promotion-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }
        
        // 6. Distribution Chart
        function createDistributionChart(data) {
            const salesByShipping = data.reduce((acc, d) => { acc[d.shipping_type] = (acc[d.shipping_type] || 0) + d.price; return acc; }, {});
            const channels = Object.keys(salesByShipping);
            const sales = Object.values(salesByShipping);

            const trace = { x: channels, y: sales, type: 'bar', marker: { color: PURPLE_PALETTE[7] }, hovertemplate: 'Shipping Type: %{x}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{y:,.0f}<extra></extra>' };
            const layout = { title: 'Revenue by Distribution Channel', xaxis: { title: 'Shipping Type' }, yaxis: { title: 'Total Revenue (₹)' }, margin: { t: 40, b: 100, l: 60, r: 20 } };

            Plotly.newPlot('distribution-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        // Sales Analytics Charts
        
        // 1. Sales Funnel Chart
        function createSalesFunnelChart(data) {
            const purchased = data.length;
            const checkoutStarted = Math.round(purchased / 0.85); 
            const addedToCart = Math.round(checkoutStarted / 0.55); 
            const productViews = Math.round(addedToCart / 0.35); 
            const totalVisits = Math.round(productViews / 0.45); 

            const values = [totalVisits, productViews, addedToCart, checkoutStarted, purchased];
            const labels = ['Total Visits', 'Product Views', 'Added to Cart', 'Checkout Started', 'Purchased'];
            const colors = PURPLE_PALETTE.slice(0, 5).reverse();

            const trace = {
                y: labels.reverse(),
                x: values.reverse(),
                mode: 'markers+lines', type: 'funnel',
                marker: { color: colors.reverse() },
                textposition: "inside",
                hovertemplate: 'Stage: %{y}<br>Count: %{x:,.0f}<extra></extra>'
            };

            const layout = {
                title: 'Sales Conversion Funnel (Transactions: ' + purchased.toLocaleString() + ')', showlegend: false,
                margin: { t: 40, b: 40, l: 150, r: 20 }
            };

            Plotly.newPlot('sales-funnel-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        // 2. Monthly Trend: Online vs. Offline Sales
        function createOnlineOfflineTrendChart(data) {
            const monthlySales = data.reduce((acc, d) => {
                const key = `${d.year}-${String(d.month).padStart(2, '0')}`;
                acc[key] = acc[key] || { online: 0, offline: 0 };
                if (d.is_online) {
                    acc[key].online += d.price;
                } else {
                    acc[key].offline += d.price;
                }
                return acc;
            }, {});

            const sortedKeys = Object.keys(monthlySales).sort();
            const onlineRev = sortedKeys.map(key => monthlySales[key].online);
            const offlineRev = sortedKeys.map(key => monthlySales[key].offline);
            const dates = sortedKeys.map(key => key.slice(5) + '-' + key.slice(0, 4));

            const traceOnline = { x: dates, y: onlineRev, name: 'Online Revenue', type: 'scatter', mode: 'lines', line: { color: PURPLE_PALETTE[0], width: 3 } };
            const traceOffline = { x: dates, y: offlineRev, name: 'Offline Revenue', type: 'scatter', mode: 'lines', line: { color: PURPLE_PALETTE[3], width: 3 } };

            const layout = {
                title: 'Monthly Revenue Trend: Online vs. Offline',
                xaxis: { title: 'Month-Year', tickangle: -45 },
                yaxis: { title: 'Revenue (₹)' },
                legend: { x: 0.1, y: 1.1, orientation: 'h' },
                margin: { t: 40, b: 100, l: 60, r: 20 }
            };

            Plotly.newPlot('online-offline-trend-chart', [traceOnline, traceOffline], layout, { responsive: true, displayModeBar: false });
        }

        // 3. Category-wise Sales Volume
        function createCategorySalesChart(data) {
            const salesByCategory = data.reduce((acc, d) => { acc[d.category] = (acc[d.category] || 0) + 1; return acc; }, {});
            const categories = Object.keys(salesByCategory);
            const counts = Object.values(salesByCategory);

            Plotly.newPlot('category-sales-chart', [{
                x: categories, y: counts, type: 'bar',
                marker: { color: PURPLE_PALETTE[1] },
                hovertemplate: 'Category: %{x}<br>Units Sold: %{y}<extra></extra>'
            }], {
                title: 'Units Sold by Category', margin: { t: 40, b: 60 }, yaxis: { title: 'Units Sold' }
            }, { responsive: true, displayModeBar: false });
        }

        // 4. Customer Segmentation by Purchase Frequency
        function createCustomerSegmentationChart(data) {
            const tiers = data.map(d => {
                if (d.previous_purchases > 30) return 'High Value (>30)';
                if (d.previous_purchases >= 10) return 'Medium Value (10-30)';
                return 'Low Value (<10)';
            });

            const counts = tiers.reduce((acc, tier) => { acc[tier] = (acc[tier] || 0) + 1; return acc; }, {});

            const trace = {
                labels: Object.keys(counts), values: Object.values(counts), type: 'pie',
                marker: { colors: [PURPLE_PALETTE[0], PURPLE_PALETTE[1], PURPLE_PALETTE[2]] },
                hovertemplate: '%{label}<br>Customers: %{value} (%{percent})<extra></extra>',
                hole: .4
            };
            const layout = { title: 'Customer Segmentation by Purchase Frequency', margin: { t: 40, b: 20, l: 20, r: 20 } };
            Plotly.newPlot('customer-segmentation-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }
        
        // 5. Competitor Comparison Chart (Pie/Doughnut)
        function createCompetitorChart() {
            const marketShareReliance = 65;
            const marketShareCompetitors = 35;

            const data = [{
                values: [marketShareReliance, marketShareCompetitors],
                labels: ['Reliance Trends', 'Key Competitors (Est.)'],
                type: 'pie',
                marker: { colors: [PURPLE_PALETTE[4], '#CCCCCC'] },
                hovertemplate: '%{label}<br>Market Share: %{value}%<extra></extra>',
                hole: .7, showlegend: true
            }];

            const layout = {
                title: { text: 'Market Share Comparison (%)', y: 0.1 },
                annotations: [{
                    font: { size: 24, color: PURPLE_PALETTE[4] },
                    showarrow: false,
                    text: `${marketShareReliance}%`,
                    x: 0.5, y: 0.5
                }],
                margin: { t: 50, b: 10, l: 10, r: 10 }
            };

            Plotly.newPlot('competitor-comparison-chart', data, layout, { responsive: true, displayModeBar: false });
        }

        // Pricing Insights Charts

        // 1. Demand Elasticity Chart
        function createDemandElasticityChart(data) {
            const monthlyData = data.reduce((acc, d) => {
                const key = `${d.year}-${String(d.month).padStart(2, '0')}`;
                acc[key] = acc[key] || { total_price: 0, count: 0 };
                acc[key].total_price += d.price;
                acc[key].count++;
                return acc;
            }, {});

            const sortedKeys = Object.keys(monthlyData).sort();
            const dates = sortedKeys;
            const avgPrices = sortedKeys.map(key => (monthlyData[key].total_price / monthlyData[key].count).toFixed(2));
            const volumes = sortedKeys.map(key => monthlyData[key].count);

            const trace1 = { x: avgPrices, y: volumes, name: 'Price vs. Volume', type: 'scatter', mode: 'markers', marker: { color: PURPLE_PALETTE[0] }, hovertemplate: 'Avg. Price: ' + formatCurrencySmall(0).substring(0, 1) + '%{x:,.2f}<br>Volume: %{y}<extra></extra>' };

            const layout = {
                title: 'Price Elasticity Curve (Avg. Price vs. Demand Volume)',
                xaxis: { title: 'Avg. Item Price (₹)' },
                yaxis: { title: 'Demand Volume (Units)' },
                margin: { t: 40, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('demand-elasticity-chart', [trace1], layout, { responsive: true, displayModeBar: false });
        }

        // 2. Average Selling Price Trend
        function createAvgPriceTrendChart(data) {
            const monthlyData = data.reduce((acc, d) => {
                const key = `${d.year}-${String(d.month).padStart(2, '0')}`;
                acc[key] = acc[key] || { total_price: 0, count: 0 };
                acc[key].total_price += d.price;
                acc[key].count++;
                return acc;
            }, {});

            const sortedKeys = Object.keys(monthlyData).sort();
            const dates = sortedKeys.map(key => key.slice(5) + '-' + key.slice(0, 4));
            const avgPrices = sortedKeys.map(key => (monthlyData[key].total_price / monthlyData[key].count).toFixed(2));

            const trace = { x: dates, y: avgPrices, name: 'Avg. Item Price', type: 'scatter', mode: 'lines', line: { color: PURPLE_PALETTE[3], width: 3 } };

            const layout = {
                title: 'Average Selling Price Trend (Monthly)',
                xaxis: { title: 'Month-Year', tickangle: -45 },
                yaxis: { title: 'Avg. Price (₹)' },
                margin: { t: 40, b: 100, l: 60, r: 20 }
            };

            Plotly.newPlot('avg-price-trend-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        // 3. Product Category Price Distribution (Box Plot)
        function createPriceDistributionBoxPlot(data) {
            const traces = CATEGORIES.map((category, index) => {
                const prices = data.filter(d => d.category === category).map(d => d.price);
                return {
                    y: prices, name: category, type: 'box',
                    marker: { color: PURPLE_PALETTE[index % PURPLE_PALETTE.length] },
                    boxpoints: false, // Hide individual points for cleaner view
                    hovertemplate: 'Category: ' + category + '<br>Price: ' + formatCurrency(0).substring(0, 1) + '%{y:,.0f}<extra></extra>'
                };
            });

            const layout = {
                title: 'Product Category Price Distribution',
                yaxis: { title: 'Item Price (₹)', zeroline: false },
                boxmode: 'group',
                margin: { t: 40, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('price-distribution-box-plot', traces, layout, { responsive: true, displayModeBar: false });
        }

        // 4. Customer Willingness-to-Pay (WTP) by Segment (Bubble Chart)
        function createWtpBubbleChart(data) {
            const segmentData = data.reduce((acc, d) => {
                const segment = d.previous_purchases > 30 ? 'High Value' : (d.previous_purchases >= 10 ? 'Medium Value' : 'Low Value');
                acc[segment] = acc[segment] || { total_price: 0, count: 0, avg_price: 0 };
                acc[segment].total_price += d.price;
                acc[segment].count++;
                return acc;
            }, {});

            Object.keys(segmentData).forEach(key => {
                segmentData[key].avg_price = segmentData[key].total_price / segmentData[key].count;
            });

            const labels = Object.keys(segmentData);
            const counts = labels.map(l => segmentData[l].count);
            const avgPrices = labels.map(l => segmentData[l].avg_price);

            const trace = {
                x: avgPrices.map(p => p * 0.001), // Scale for X-axis
                y: counts.map(c => c / 100), // Scale for Y-axis
                mode: 'markers',
                marker: {
                    size: counts.map(c => c * 0.05), // Bubble size based on customer count
                    color: PURPLE_PALETTE.slice(0, 3),
                    sizeref: 2 * Math.max(...counts) / (40**2), // Adjust for better visual size
                    sizemode: 'area'
                },
                text: labels,
                hovertemplate: 'Segment: %{text}<br>Avg. Price: ' + formatCurrency(0).substring(0, 1) + '%{x:,.0f}K<br>Customers: %{y:.0f}K<extra></extra>'
            };

            const layout = {
                title: 'Customer WTP by Segment (Avg. Price vs. Volume)',
                xaxis: { title: 'Avg. Item Price (in 1000s ₹)', tickformat: ',.0f' },
                yaxis: { title: 'Customer Volume (in 100s)', tickformat: ',.0f' },
                margin: { t: 40, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('wtp-bubble-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }
        
        // 5. Competitor-wise Pricing Comparison
        function createCompetitorPricingChart() {
            // Synthetic average prices based on market segment
            const competitorPrices = {
                'Reliance Trends': 4900,
                'Pantaloons': 5100,
                'Max Fashion': 3500,
                'Lifestyle': 6200
            };

            const labels = Object.keys(competitorPrices);
            const prices = Object.values(competitorPrices);

            const trace = {
                x: labels, y: prices, type: 'bar',
                marker: { 
                    color: labels.map(l => l === 'Reliance Trends' ? PURPLE_PALETTE[0] : PURPLE_PALETTE[4]) 
                },
                hovertemplate: 'Competitor: %{x}<br>Avg. Price: ' + formatCurrency(0).substring(0, 1) + '%{y:,.0f}<extra></extra>'
            };
            
            const layout = {
                title: 'Competitor-wise Avg. Pricing',
                xaxis: { title: 'Brand' },
                yaxis: { title: 'Avg. Item Price (₹)' },
                margin: { t: 40, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('competitor-pricing-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }
        
        // Profitability Metrics Charts

        // 1. Profit Margin Trend Over Time (Quarterly)
        function createMarginTrendChart(data) {
            const quarterlyMargin = data.reduce((acc, d) => {
                const quarter = `${d.year}-Q${Math.ceil(d.month / 3)}`;
                acc[quarter] = acc[quarter] || { revenue: 0, transactions: 0 };
                acc[quarter].revenue += d.price;
                acc[quarter].transactions++;
                return acc;
            }, {});

            const sortedKeys = Object.keys(quarterlyMargin).sort();
            const margins = sortedKeys.map(key => {
                // Assume a fixed GPM of 30% but add small random variation to show a trend
                const baseMargin = 0.30;
                const variation = (Math.random() * 0.05 - 0.025); // +/- 2.5% variation
                return (baseMargin + variation) * 100;
            });

            const trace = {
                x: sortedKeys, y: margins, type: 'scatter', mode: 'lines+markers',
                line: { color: PURPLE_PALETTE[0], width: 3 },
                marker: { size: 8 },
                hovertemplate: 'Quarter: %{x}<br>Margin: %{y:.1f}%<extra></extra>'
            };
            
            const layout = {
                title: 'Gross Profit Margin Trend (Quarterly)',
                xaxis: { title: 'Quarter' },
                yaxis: { title: 'Margin (%)', range: [25, 35] },
                margin: { t: 40, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('margin-trend-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        // 2. Product-wise Profit Comparison
        function createProductProfitChart(data) {
            const profitByItem = data.reduce((acc, d) => { 
                const profit = d.price * 0.30;
                acc[d.item_purchased] = (acc[d.item_purchased] || 0) + profit; 
                return acc; 
            }, {});
            
            const sortedItems = Object.entries(profitByItem).sort(([, a], [, b]) => b - a).slice(0, 5);
            const items = sortedItems.map(([item]) => item).reverse();
            const profit = sortedItems.map(([, p]) => p).reverse();

            Plotly.newPlot('product-profit-chart', [{
                x: profit, y: items, type: 'bar', orientation: 'h',
                marker: { color: PURPLE_PALETTE[3] },
                hovertemplate: 'Product: %{y}<br>Profit: ' + formatCurrency(0).substring(0, 1) + '%{x:,.0f}<extra></extra>'
            }], {
                title: 'Top 5 Products by Estimated Profit', margin: { t: 40, b: 40, l: 100, r: 20 }, xaxis: { title: 'Estimated Profit (₹)' }
            }, { responsive: true, displayModeBar: false });
        }
        
        // 3. Region-wise Profitability (Pie Chart of Revenue)
        function createRegionProfitPieChart(data) {
            const salesByLocation = data.reduce((acc, d) => { acc[d.location] = (acc[d.location] || 0) + d.price; return acc; }, {});
            const locations = Object.keys(salesByLocation);
            const revenue = Object.values(salesByLocation);

            const trace = {
                labels: locations, values: revenue, type: 'pie',
                marker: { colors: PURPLE_PALETTE.slice(0, locations.length) },
                hovertemplate: '%{label}<br>Revenue: ' + formatCurrency(0).substring(0, 1) + '%{value:,.0f} (%{percent})<extra></extra>',
                hole: .4
            };
            const layout = { title: 'Region-wise Revenue (Profit Proxy)', margin: { t: 40, b: 20, l: 20, r: 20 } };
            Plotly.newPlot('region-profit-pie-chart', [trace], layout, { responsive: true, displayModeBar: false });
        }
        
        // 4. Promotion ROI vs Spend (Scatter Plot)
        function createPromotionRoiScatter(data) {
            // Aggregate all promotion spends and ROIs (synthetic for this chart)
            const promoData = data.slice(0, 50).map(d => ({ 
                spend: d.promotion_spend, 
                roi: d.promotion_roi 
            }));

            const trace = {
                x: promoData.map(d => d.spend),
                y: promoData.map(d => d.roi),
                mode: 'markers',
                marker: {
                    size: 10,
                    color: PURPLE_PALETTE[7],
                    opacity: 0.7
                },
                hovertemplate: 'Spend: ₹%{x:,.0f}<br>ROI: %{y:.2f}x<extra></extra>'
            };
            
            const layout = {
                title: 'Promotion ROI vs. Spend',
                xaxis: { title: 'Promotion Spend (₹)' },
                yaxis: { title: 'Return on Investment (ROI, x)' },
                margin: { t: 40, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('promotion-roi-scatter', [trace], layout, { responsive: true, displayModeBar: false });
        }


        // Map Visualization (Leaflet.js)
        function initMaduraiMap(data) {
            const locationSales = { ...MADURAI_LOCATIONS };
            Object.values(locationSales).forEach(loc => loc.sales = 0);

            data.forEach(d => {
                if (locationSales[d.location]) {
                    locationSales[d.location].sales += d.price;
                }
            });

            const maxSales = Math.max(...Object.values(locationSales).map(l => l.sales));

            if (window.map) {
                window.map.remove();
            }
            // Set initial view on Madurai
            window.map = L.map('map-container').setView([9.9252, 78.1198], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18, attribution: '© OpenStreetMap contributors'
            }).addTo(window.map);

            Object.keys(locationSales).forEach(locName => {
                const loc = locationSales[locName];
                if (loc.lat && loc.lon) {
                    const radius = 8 + (loc.sales / maxSales) * 15;
                    const colorIntensity = loc.score / 100; // 0 to 1
                    
                    // Simple color gradient based on score (green/yellow/red, for contrast to purple)
                    const getColor = (score) => {
                        return score > 90 ? '#008000' :
                               score > 80 ? '#ADFF2F' :
                               score > 70 ? '#FFA500' :
                                            '#FF4500';
                    };

                    L.circleMarker([loc.lat, loc.lon], {
                        radius: radius, 
                        color: PURPLE_PALETTE[0],
                        fillColor: getColor(loc.score), // Color based on Score
                        fillOpacity: 0.8, 
                        weight: 1.5
                    }).addTo(window.map)
                      .bindPopup(`<b>${locName}</b><br>Revenue: ${formatCr(loc.sales)}<br>Location Score: ${loc.score}/100<br>Competitors Nearby: ${loc.competitor}`);
                }
            });
            window.map.invalidateSize();
        }

        // Profitability Table
        function updateProfitabilityMetricsTable(data) {
            const salesByCategory = data.reduce((acc, d) => { acc[d.category] = (acc[d.category] || 0) + d.price; return acc; }, {});

            let tableHTML = '';
            for (const category in salesByCategory) {
                const revenue = salesByCategory[category];
                // Use a slightly different margin for each category for realism
                const margin = (category === 'Clothing' || category === 'Footwear') ? 0.35 : 0.25;
                const grossProfit = revenue * margin;
                const marginPercent = margin * 100;
                tableHTML += `
                    <tr>
                        <td>${category}</td>
                        <td>${formatCurrency(revenue)}</td>
                        <td>${formatCurrency(grossProfit)}</td>
                        <td>${marginPercent.toFixed(1)}%</td>
                    </tr>
                `;
            }
            document.getElementById('profitability-table-body').innerHTML = tableHTML;
        }

        // --- DASHBOARD CONTROL LOGIC ---

        function updateDashboard() {
            const selectedYear = document.getElementById('year-filter').value;
            const selectedLocation = document.getElementById('location-filter').value;
            const filteredData = filterData(SALES_DATA, selectedYear, selectedLocation);
            const metrics = calculateMetrics(SALES_DATA); // Use ALL_TIME for most KPIs

            // Update KPIs
            document.getElementById('kpi-revenue').textContent = formatCr(metrics.allTimeRevenue);
            document.getElementById('kpi-apv').textContent = formatCurrencySmall(metrics.apv);
            document.getElementById('kpi-gpm').textContent = formatPercent(metrics.grossMarginPercent * 100);
            document.getElementById('kpi-transactions').textContent = metrics.totalTransactions.toLocaleString();

            document.getElementById('kpi-rating').textContent = `${metrics.avgRating.toFixed(2)} / 5.0`;
            document.getElementById('kpi-customers').textContent = metrics.totalCustomers.toLocaleString() + '+';
            document.getElementById('kpi-repeat').textContent = metrics.repeatRate;
            document.getElementById('kpi-conversion-sales').textContent = metrics.conversion;
            
            document.getElementById('kpi-profit').textContent = formatCr(metrics.estimatedProfit);
            document.getElementById('kpi-cogs').textContent = formatCr(metrics.estimatedCOGS);
            document.getElementById('kpi-cac').textContent = formatCurrencySmall(metrics.kpi_cac);
            document.getElementById('kpi-ltv').textContent = formatCurrencySmall(metrics.kpi_ltv);

            // Redraw Charts (using filtered data)
            // Home Section
            createRevenueTrendChart(filteredData);
            createAgeSalesChart(filteredData);
            createProductSalesChart(filteredData);
            createLocationSalesChart(filteredData);
            createPromotionChart(filteredData);
            createDistributionChart(filteredData);

            // Sales Analytics
            createSalesFunnelChart(filteredData);
            createOnlineOfflineTrendChart(filteredData);
            createCategorySalesChart(filteredData);
            createCustomerSegmentationChart(filteredData);
            createCompetitorChart();
            
            // Pricing Insights
            createDemandElasticityChart(filteredData);
            createAvgPriceTrendChart(filteredData);
            createPriceDistributionBoxPlot(filteredData);
            createWtpBubbleChart(filteredData);
            createCompetitorPricingChart();

            // Profitability Metrics
            createMarginTrendChart(filteredData);
            createProductProfitChart(filteredData);
            createRegionProfitPieChart(filteredData);
            createPromotionRoiScatter(filteredData);
            updateProfitabilityMetricsTable(filteredData);
            
            // Map
            initMaduraiMap(filteredData); // Map redraw
        }

        // --- SIDEBAR & NAVIGATION HANDLER ---

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const desktopToggle = document.getElementById('sidebar-toggle-desktop');
        const mobileToggle = document.getElementById('sidebar-toggle-mobile');
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.dashboard-section');

        function toggleSidebar() {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('shifted');
            desktopToggle.querySelector('.material-symbols-outlined').textContent = isCollapsed ? 'chevron_right' : 'chevron_left';
            setTimeout(() => {
                // Resize all plots
                sections.forEach(section => Plotly.Plots.resize(section));
                if (window.map) window.map.invalidateSize();
            }, 300);
        }

        function setActiveSection(sectionId) {
            sections.forEach(section => {
                section.style.display = 'none';
                section.style.opacity = 0;
            });
            navItems.forEach(item => item.classList.remove('active'));

            const targetSection = document.getElementById(sectionId);
            const targetNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);

            if (targetSection) {
                targetSection.style.display = 'block';
                // Trigger fade-in animation
                setTimeout(() => {
                    targetSection.style.opacity = 1;
                    // Resize charts in the active section after the section is visible
                    Plotly.Plots.resize(targetSection);
                    if (sectionId === 'distribution' && window.map) {
                        window.map.invalidateSize();
                    }
                }, 50);
            }
            if (targetNavItem) {
                targetNavItem.classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Event Listeners
        desktopToggle.addEventListener('click', toggleSidebar);
        mobileToggle.addEventListener('click', () => { 
            if (window.innerWidth < 768) { 
                sidebar.classList.toggle('open'); 
            } else { 
                toggleSidebar(); 
            } 
        });

        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                setActiveSection(sectionId);
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });
        });

        // Initialize dashboard state
        document.addEventListener('DOMContentLoaded', () => {
            populateLocationFilter();
            setActiveSection('home');
            updateDashboard();

            // Set initial collapse state for desktop
            if (window.innerWidth > 992) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('shifted');
                desktopToggle.querySelector('.material-symbols-outlined').textContent = 'chevron_right';
            }
        });

        window.addEventListener('resize', () => {
            if (window.map) window.map.invalidateSize();
            // Debounced resize for plotly charts on window resize
            setTimeout(() => {
                sections.forEach(section => Plotly.Plots.resize(section));
            }, 100);
        });

    </script>
</body>
</html>
